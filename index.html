<!DOCTYPE html>
<meta charset="utf-8">
<style>

.link {
  fill: none;
  stroke: #666;
  stroke-width: 1.5px;
}

.node circle {
  fill: #ccc;
  stroke: #fff;
  stroke-width: 1.5px;
}

.node text {
  font: 16px sans-serif;
  font-weight:bold;
  pointer-events: none;
  fill:#ffffff;
  stroke-width:0px;
}

</style>
<body>
<script src="//d3js.org/d3.v3.min.js"></script>
<script>

window.addEventListener('resize', resize);

// http://blog.thomsonreuters.com/index.php/mobile-patent-suits-graphic-of-the-day/
var links = [
  {source: "Microsoft", target: "Amazon", type: "licensing"},
  {source: "Microsoft", target: "HTC", type: "licensing"},
  {source: "Samsung", target: "Apple", type: "suit"},
  {source: "Motorola", target: "Apple", type: "suit"},
  {source: "Nokia", target: "Apple", type: "resolved"},
  {source: "HTC", target: "Apple", type: "suit"},
  {source: "Kodak", target: "Apple", type: "suit"},
  {source: "Microsoft", target: "Barnes & Noble", type: "suit"},
  {source: "Microsoft", target: "Foxconn", type: "suit"},
  {source: "Oracle", target: "Google", type: "suit"},
  {source: "Apple", target: "HTC", type: "suit"},
  {source: "Microsoft", target: "Inventec", type: "suit"},
  {source: "Samsung", target: "Kodak", type: "resolved"},
  {source: "LG", target: "Kodak", type: "resolved"},
  {source: "RIM", target: "Kodak", type: "suit"},
  {source: "Sony", target: "LG", type: "suit"},
  {source: "Kodak", target: "LG", type: "resolved"},
  {source: "Apple", target: "Nokia", type: "resolved"},
  {source: "Qualcomm", target: "Nokia", type: "resolved"},
  {source: "Apple", target: "Motorola", type: "suit"},
  {source: "Microsoft", target: "Motorola", type: "suit"},
  {source: "Motorola", target: "Microsoft", type: "suit"},
  {source: "Huawei", target: "ZTE", type: "suit"},
  {source: "Ericsson", target: "ZTE", type: "suit"},
  {source: "Kodak", target: "Samsung", type: "resolved"},
  {source: "Apple", target: "Samsung", type: "suit"},
  {source: "Kodak", target: "RIM", type: "suit"},
  {source: "Nokia", target: "Qualcomm", type: "suit"}
];

var nodes = {};

// Compute the distinct nodes from the links.
links.forEach(function(link) {
  link.source = nodes[link.source] || (nodes[link.source] = {name: link.source});
  link.target = nodes[link.target] || (nodes[link.target] = {name: link.target});
});

var width = 960,
    height = 500;
    
var rectWidth = 120
    rectHeight = 20
    radius = 15
    textXOffset = 10
    textYOffset = 10
    boxRadius = 5
    zoom = 1.7
    animInTime = 200
    animOutTime = 700


var force = d3.layout.force()
    .nodes(d3.values(nodes))
    .links(links)
    .size([width, height])
    .linkDistance(85)
    .charge(-700)
    .on("tick", tick)
    .start();

var svg = d3.select("body").append("svg")
    .attr("width", width)
    .attr("height", height);

var link = svg.selectAll(".link")
    .data(force.links())
    .enter().append("line")
    .attr("class", "link");

var node = svg.selectAll(".node")
    .data(force.nodes())
    .enter().append("g")
    .attr("class", "node")
    .on("mouseover", mouseover)
    .on("mouseout", mouseout)
    .on("click", click)
    .call(force.drag);

    
function resize() {
    var width = window.innerWidth, height = window.innerHeight;
    svg.attr("width", width).attr("height", height);
    force.size([width, height]).resume();

}
    
var a = node.append("a")
   // .attr("xlink:href", "http://en.wikipedia.org/wiki/")   
    

   
var rect = a.append("rect") 
    .attr("x", 0)
    .attr("y", 0)
    .attr("height", rectHeight)
    .attr("width", rectWidth)
    .style("fill", "red")
    .attr("rx", boxRadius)
    .attr("ry", boxRadius)
    

    
var txt = a.append("text")
.attr("class","text")
    .attr("x", boxRadius)
    .attr("y", boxRadius)
    .text(function(d) {  return d.name; });

var anchors = d3.selectAll('a');


anchors[0].forEach( function( elem ){


    childs =  elem.childNodes;
    
    
    var _rect = childs[0];
    var _text = childs[1];
        
    var textSize = _text.getBBox();
    
    //d3.select(_text).attr("y", textSize.height);
    
    w = textSize.width + 2 * textXOffset + 2*boxRadius;
    h = textSize.height + 2*textYOffset + boxRadius;
    
    
    _rect.setAttribute("x",-w/2);
    _rect.setAttribute("y",-h/2);
    _text.setAttribute("x",-w/2 + textXOffset +boxRadius );
    
   // _text.setAttribute("y",- boxRadius );
    
    

    console.log( h );
        
    _rect.setAttribute("width", textSize.width + 2*textXOffset + 2*boxRadius )
    _rect.setAttribute("height", textSize.height + 2*textYOffset + boxRadius )

});



resize();




function tick() {
  link
      .attr("x1", function(d) { return d.source.x; })
      .attr("y1", function(d) { return d.source.y; })
      .attr("x2", function(d) { return d.target.x; })
      .attr("y2", function(d) { return d.target.y; });

  node
      .attr("transform", function(d) { return "translate(" + d.x + "," + d.y + ")"; });
}


function click(d) {
  //if (d3.event.defaultPrevented) return; // ignore drag
  
  console.log( d3.select( this ).selectAll(".node") );

}


function mouseover() {


   var selection = d3.select(this).select("rect");
   
   var offsetX = parseFloat(selection.attr("x"))+ parseFloat(selection.attr("width")/2.0);
   var offsetY = parseFloat(selection.attr("y"))+ parseFloat(selection.attr("height")/2.0);
     
   selection.transition().duration(animInTime)
     
                    .attr({
                        transform:"translate("+offsetX+ ","+offsetY+") "+
                                  "scale(" + zoom  + ") "+
                                  "translate(-"+offsetX+",-"+offsetY+ ")"});
      

}

function mouseout() {


   var selection = d3.select(this).select("rect");
   
   var offsetX = parseFloat(selection.attr("x"))+ parseFloat(selection.attr("width")/2.0);
   var offsetY = parseFloat(selection.attr("y"))+ parseFloat(selection.attr("height")/2.0);
     
   selection.transition().duration(animOutTime)
     
                    .attr({
                        transform:"translate("+offsetX+ ","+offsetY+") "+
                                  "scale(" + ( 1 ) + ") "+
                                  "translate(-"+offsetX+",-"+offsetY+ ")"});

}

</script>

</body>
</html>
