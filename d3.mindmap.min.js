d3.mindMap=function(t){function e(t){shiftClicked=t.shiftKey,ctrlClicked=t.ctrlKey}function n(t,e){t.each(function(){var t=d3.select(this),e=t.attr("title").split(/\r?\n/);interline=10,fs=J(t.node(),"fontSize")||"10",lines=0,t.text(""),e.forEach(function(e){tspan=t.append("tspan").attr("x",0).attr("dy",fs).text(e)})})}function r(t,e,r,i,o,a,l){function c(){var t=title.node().value;s.name=t,h.attr("title",t).call(n);var e=inp.node().value;s.textcontent=e,m=!0,d3.selectAll("div#d3-mindmap-node-editor").remove(),d(q)}if(e){var s=g(e.id,q),u=ct.select("#JIKU_MM_TEXT_"+s.id)[0][0];if(d3.selectAll("div#d3-mindmap-node-editor").remove(),u){var f=s.name,p=s.textcontent||"",h=d3.select(u);posX=i,posY=o,ww=document.documentElement.scrollWidth,hh=document.documentElement.scrollHeight,frm=d3.select("body").append("div").attr("id","d3-mindmap-node-editor"),frm.style("position","absolute");var m=!1;form=frm.append("xhtml:form").on("submit",function(){return d3.event.preventDefault(),null}).classed("rename-form",!0),form.append("span").text("Titolo"),title=form.append("textarea").classed("d3-mindmap-node-editor-title",!0),title.attr("placeholder","Inserire il titolo...").attr("value",function(){return this.focus(),title[0][0].value=f,f}),form.append("span").text("Contenuto"),inp=form.append("textarea").attr("placeholder","Inserire il contenuto...").classed("rename-form",!0),inp.attr("value",function(){return inp[0][0].value=p,p}),buttContainer=form.append("div"),buttContainer.classed("inner",!0),canc=buttContainer.append("xhtml:button").classed("d3-mindmap-little-button",!0).text("Annulla").on("click",function(){m=!0,d3.selectAll("div#d3-mindmap-node-editor").remove()}),ok=buttContainer.append("xhtml:button").classed("d3-mindmap-little-button",!0).text("Salva").on("click",c),frmWidth=frm.node().getBoundingClientRect().width,frmHeight=frm.node().getBoundingClientRect().height,posX+frmWidth>ww&&(posX=ww-frmWidth),posY+frmHeight>hh&&(posY=hh-frmHeight),frm.attr("style","left:"+posX+"px; top:"+posY+"px;")}}}function o(t){ct.select(".d3-x-axis").call(dt),ct.select(".d3-y-axis").call(at),K=t&&t.scale||d3.event&&d3.event.scale,trans=t&&t.translate||d3.event&&d3.event.translate,K&&trans&&(tr1=[trans[0]*K,trans[1]*K],tr2=[trans[0]/K,trans[1]/K],rect.attr("transform","scale("+K+")translate("+tr2+")"),P.viewport={scale:K,translate:tr1},a())}function d(t){var e=_(t),r=d3.layout.tree().links(e);pt=e,a(),et.nodes(e).links(r).linkDistance(10*fontSize).charge(-8e3).gravity(.05).friction(0).size([Z,height]).start(),ut=ut.data(r,function(t){return t.target.id}),ut.exit().remove(),ut.enter().insert("path",".d3-mindmap-node").classed("d3-mindmap-link",!0).style("stroke-width",O).attr("marker-end","url(#end)");var i=et.drag();B&&i.on("drag",b).on("dragstart",M).on("dragend",k),ft=ft.data(e,function(t){return t.id}),ft.exit().remove();var o=ft.enter().append("g").attr("id",function(t){return"JIKU_MM_NODE_"+t.id}).attr("class","d3-mindmap-node").on("click",A).on("touchstart",A).on("mouseover",E).on("mouseout",z);B&&o.call(i);var d=o.append("rect").attr("x",0).attr("y",0).attr("height",X).attr("width",L).attr("id",function(t){return"JIKU_MM_RECT_"+t.id}).attr("class",function(t){return s(t.isLeaf)?t.isLeaf?"d3-mindmap-leaf":"d3-mindmap-parent":void 0}),l=(o.append("text").attr("class","text").style("text-anchor","middle").attr("id",function(t){return"JIKU_MM_TEXT_"+t.id}).attr("class",function(t){return t.url?"d3-mindmap-hyperlink":void 0}).attr("title",function(t){return t.name}).call(n),o.append("g").attr("class","textcontentcircle")),c=(l.append("circle").style("fill","#50e050").style("stroke","#505020").attr("cx",0).attr("cy",0).attr("r",10).attr("id",function(t){return"JIKU_MM_CIRCLE_"+t.id}).on("mouseover",N).on("mouseout",S),l.append("text").style("text-anchor","middle").style("font-size","15px").style("font-style","italic").attr("x",-1).attr("y",5).attr("width",12).attr("height",12).text("i"),d3.selectAll("g.d3-mindmap-node"));B?d.on("contextmenu",d3.contextMenu(V)):d.on("contextmenu",d3.contextMenu($)),c[0].forEach(function(t){childs=t.childNodes,anchors=childs[0].childNodes,_rect=childs[0],_text=childs[1],fontSize=J(d3.select(_text).node(),"fontSize")||"10",radius=parseInt(J(d3.select(_rect).node(),"border-radius")||"20"),_rect.setAttribute("rx",radius),_rect.setAttribute("ry",radius),fontSize=parseInt(fontSize),textSize=_text.getBBox(),w=textSize.width+2*Y,h=textSize.height+2*R,_rect.setAttribute("x",-w/2),_rect.setAttribute("y",-h/2),_text.setAttribute("y",-h/2+fontSize/2),_rect.setAttribute("width",w),_rect.setAttribute("height",h),_circles=d3.select(t).select("g.textcontentcircle"),_circles.attr("transform","translate("+w/2+","+h/2+")").attr("visibility",function(t,e){return t.textcontent?"visible":"hidden"})})}function a(){B&&document.getElementById(W)&&(document.getElementById(W).value=JSON.stringify(x(P)))}function l(t){return perc=.65,targetX=t.source.x+perc*(t.target.x-t.source.x),targetY=t.source.y+perc*(t.target.y-t.source.y),"M"+t.target.x+","+t.target.y+"L"+ +t.source.x+","+t.source.y+"M"+targetX+","+targetY}function c(){ut.attr("d",l),ft.attr("transform",function(t){return"translate("+t.x+","+t.y+")"}),F&&et.stop(),a()}function s(t){return null!==t&&"undefined"!=typeof t}function u(t){var e=!1;return e=s(t.children)||s(t._children)}function f(t){Array.isArray(t)?t.forEach(function(t){f(t)}):(t._children&&(t.children||(t.children=[]),t._children.forEach(function(e){t.children.push(e)}),t._children=null),t.children&&t.children.forEach(function(t){f(t)}))}function p(t){Array.isArray(t)?t.forEach(function(t){p(t)}):(t.children&&(t._children||(t._children=[]),t.children.forEach(function(e){t._children.push(e)}),t.children=null),t._children&&t._children.forEach(function(t){p(t)}))}function m(t,e){if(s(e))for(i=0;i<e.length;i+=1)if(e[i].id===t)return e[i];return null}function v(t,e){function n(t,e){function r(t,r){for(i=0;i<r.length;i++){if(o=r[i],o.id==t){if(console.log("Found, removing "),r.splice(i,1),0==r.length){e.isLeaf=!0;var d=ct.select("#JIKU_MM_RECT_"+e.id);d&&d.attr("class","d3-mindmap-leaf")}return o}n(t,o)}}var i,o;s(e)&&(e.children&&r(t,e.children),e._children&&r(t,e._children))}var r,i;if(console.log("Removing "+t),Array.isArray(e))for(r=0;r<e.length;r++)i=e[r],i.id==t?e.splice(r,1):n(t,i);else n(t,e)}function x(t){function e(t){function n(t){for(r=0;r<t.length;r++)i=t[r],e(i)}var r,i;if(delete t.fixed,delete t.px,delete t.py,delete t.weight,delete t.isLeaf,delete t.index,delete t.size,delete t.status,t.x=Math.floor(t.x),t.y=Math.floor(t.y),s(t)){if(t._children)for(t.children||(t.children=[]),r=0;r<t._children.length;r++)t.children.push(t._children[r]);delete t._children,t.children&&n(t.children)}}var n,r;if(__currentNode=JSON.clone(t),__currentNode.viewport.translate[0]=Math.floor(__currentNode.viewport.translate[0]),__currentNode.viewport.translate[1]=Math.floor(__currentNode.viewport.translate[1]),_nodes=__currentNode.nodes,Array.isArray(_nodes))for(n=0;n<_nodes.length;n++)r=_nodes[n],e(r);else e(_nodes);return __currentNode.nodes=_nodes,__currentNode}function g(t,e){var n,r,i;if(Array.isArray(e)){for(var n=0;n<e.length;n++)if(elem=e[n],res=g(t,elem),res!==!1)return res}else{if(t==e.id)return e;if(s(e)&&s(e.children))for(var n=0;n<e.children.length;n+=1)if(r=e.children[n],i=g(t,r),i!==!1)return i}return!1}function y(t){function e(t){var n=0;return t.children&&(n+=t.children.length,t.children.forEach(function(t){t.children&&(n+=e(t))})),n}if(Array.isArray(t)){var n=0;return t.forEach(function(t){n+=e(t)}),n+t.length}return e(t)}function _(t){function e(t){t.isLeaf=!0,F?t.fixed=!0:delete t.fixed,t.children?(t.size=t.children.reduce(function(t,n){return t+e(n)},0),t.isLeaf=!1):t._children&&(t.isLeaf=!1),t.id||(t.id=++G),n.push(t)}var n=[];return Array.isArray(t)?t.forEach(function(t){flat=_(t),flat.forEach(function(t){n.push(t)})}):e(t),n}function A(t){if(!d3.event.defaultPrevented){if(t.children){if(s(t)){console.log("Collapsing "+t.id);var e=m(t.id,pt);e.isLeaf=!1}t._children=t.children,t.children=null}else if(t.children=t._children,t._children=null,u(t)){var e=m(t.id,pt);e.isLeaf=!1}d(q)}}function M(t){d3.event.sourceEvent.stopPropagation()}function k(t){d3.event.sourceEvent.stopPropagation()}function b(t){var e=(d3.selectAll("#JIKU_MM_NODE_"+t.id),g(t.id,q));e.x=t.px+d3.event.dx,e.y=t.py+d3.event.dy,ctrlClicked&&t.children&&t.children.forEach(function(t){var e=d3.select("#JIKU_MM_NODE_"+t.id);b(t),e.attr("transform",function(t){t.px=t.px+d3.event.dx,t.py=t.py+d3.event.dy})}),d(q)}function E(t){if(nt=d3.selectAll("div#"+H),!B||!(j=d3.select("#d3-mindmap-node-editor").node())){lt.on("zoom",function(){}),ct.call(lt.event);var e=d3.select(this),n=e.select("rect"),r=d3.select(this).select("text");e.moveToFront(),B&&(n.classed("d3-mindmap-hover",!0),r.classed("d3-mindmap-hover",!0)),nt.on("contextmenu",null),e.on("contextmenu",null),e.on("contextmenu",d3.contextMenu($)),B?e.on("contextmenu",d3.contextMenu(V)):e.on("contextmenu",d3.contextMenu($))}}function z(t){nt=d3.selectAll("div#"+H),lt.on("zoom",o),ct.call(lt);var e=d3.select(this),n=e.select("rect"),r=d3.select(this).select("text");n.classed("d3-mindmap-hover",!1),r.classed("d3-mindmap-hover",!1),nt.on("contextmenu",null),e.on("contextmenu",null),B?nt.on("contextmenu",d3.contextMenu(Q)):nt.on("contextmenu",d3.contextMenu($))}function N(t){return d3.event.preventDefault(),nt=d3.selectAll("div#"+H),rem=d3.selectAll("div#d3-mindmap-details"),rem.empty()?(B&&nt.on("contextmenu",d3.contextMenu(Q)),void(t.textcontent&&(nt=d3.select("body").append("div"),nt.attr("id","d3-mindmap-details").attr("style","top:"+d3.event.pageY+"px; left:"+d3.event.pageX+"px;"),str=t.textcontent.split(/(?:\r\n|\r|\n)/g),str.forEach(function(t){st=t,"object"==typeof he&&(st=he.decode(t)),nt.append("span").text(st),nt.append("br")})))):void rem.remove()}function S(t){d3.selectAll("div#d3-mindmap-details").remove()}function C(t,e){return d3.transition().duration(350).tween("zoom",function(){var n=d3.interpolate(lt.translate(),t),r=d3.interpolate(lt.scale(),e);return function(t){lt.scale(r(t)).translate(n(t)),P.viewport.scale=r(t),P.viewport.translate=n(t),o(P.viewport)}})}function I(){var t=(d3.event.target,1),e=.2,n=1,r=[Z/2,height/2],i=lt.scaleExtent(),o=lt.translate(),d=[],a=[],l={x:o[0],y:o[1],k:lt.scale()};return d3.event.preventDefault(),t="zoom_in"===this.id?1:"zoom_out"===this.id?-1:0,n=0==t?1:lt.scale()*(1+e*t),n<i[0]||n>i[1]?!1:(d=[(r[0]-l.x)/l.k,(r[1]-l.y)/l.k],l.k=n,a=[d[0]*l.k+l.x,d[1]*l.k+l.y],l.x+=r[0]-a[0],l.y+=r[1]-a[1],void C([l.x,l.y],l.k))}function J(t,e,n,r){return n=window.getComputedStyle,r=n?n(t):t.currentStyle,r?r[e.replace(/-(\w)/gi,function(t,e){return e.toUpperCase()})]:void 0}"function"!=typeof JSON.clone&&(JSON.clone=function(t){return JSON.parse(JSON.stringify(t))}),d3.contextMenu=function(t,e){return d3.selectAll(".d3-context-menu").data([1]).enter().append("div").attr("class","d3-context-menu"),d3.select("body").on("click.d3-context-menu",function(){d3.select(".d3-context-menu").style("display","none")}),function(n,r){var i=this;d3.selectAll("div#d3-mindmap-node-editor").remove(),d3.selectAll(".d3-context-menu").html(""),d3.selectAll(".d3-context-menu").on("contextmenu",function(){d3.event.preventDefault()});var o=d3.selectAll(".d3-context-menu").append("ul"),d=d3.mouse(document.getElementById("d3-mindmap-svg-root")),a=d3.event.pageX,l=d3.event.pageY,c=(d[0]-trans[0])/K,s=(d[1]-trans[1])/K,d=d3.mouse;o.selectAll("li").data(t).enter().append("li").html(function(t){return t.title}).on("click",function(t,e){t.action(i,n,r,a,l,c,s),d3.select(".d3-context-menu").style("display","none")}),e&&e(n,r),d3.select(".d3-context-menu").style("left",d3.event.pageX-2+"px").style("top",d3.event.pageY-2+"px").style("display","block"),d3.event.preventDefault()}},d3.selection.prototype.moveToFront=function(){return this.each(function(){this.parentNode.appendChild(this)})},d3.select("body").on("keydown",function(){e(d3.event)}).on("keyup",function(){e(d3.event)});var L=120,X=20,K=1,O=2;shiftClicked=!1,ctrlClicked=!1,fontSize=10;var D=t&&t.width||960,T=t&&t.height||500,U=t&&t.initialDistance||150,Y=t&&t.textXMargin||10,R=t&&t.textYMargin||10,B=t&&t.editable,H=t&&t.container||"cont",W=t&&t.results||"result",F=t&&t.fixedNodes,P=t&&t.nodes||{nodes:[],viewport:{scale:1,translate:[0,0]}},Z=D;height=T;var j,q=P.nodes,G=y(q),Q=[{title:"Add new node",action:function(t,e,n,i,o,a,l){var c=JSON.clone(tt);c.id=++G,c.name="",c.isLeaf=!0,c.x=a,c.y=l,F?c.fixed=!0:delete c.fixed,Array.isArray(q)||(q=[q]),q.push(c),d(q),r(t,c,n,i,o,a,l)}},{title:"Expand all",action:function(t,e,n){f(q),d(q)}},{title:"Collapse all",action:function(t,e,n){p(q),d(q)}}],V=[{title:"Add sub node",action:function(t,e,n,i,o,a,l){if(e){var c=g(e.id,q);c.isLeaf&&(c.children=[],c._children=null);var s=c.children||c._children||null;if(s){var u=2*Math.random()*Math.PI,f=JSON.clone(tt);f.id=++G,f.name="",f.x=c.x+U*Math.sin(u),f.y=c.y+U*Math.cos(u),F?f.fixed=!0:delete f.fixed,s.push(f),c.isLeaf=!1;var p=ct.select("#JIKU_MM_RECT_"+c.id);p&&p.attr("class","d3-mindmap-parent"),d(q),d3.select("#JIKU_MM_NODE_"+e.id).moveToFront(),r(t,f,n,i,o,a,l)}}}},{title:"Edit node",action:function(t,e,n,i,o,d,a){r(t,e,n,i,o,d,a)}},{title:"Remove node",action:function(t,e,n){if(e){v(e.id,q);d(q)}}}],$=[{title:"Expand all",action:function(t,e,n){f(q),d(q)}},{title:"Collapse all",action:function(t,e,n){p(q),d(q)}}],tt={name:"New node",isLeaf:!0,url:""},et=d3.layout.force().size([Z,height]).on("tick",c),nt=d3.selectAll("div#"+H);nt.style("position","relative").style("width",Z+"px").style("height",height+"px");var rt=nt.append("div").attr("id","d3-mindmap-zoom-controls");rt.append("button").text("Zoom +").classed("d3-mindmap-little-button",!0).attr("id","zoom_in").on("click",I),rt.append("button").text("Reset").classed("d3-mindmap-little-button",!0).attr("id","zoom_reset").on("click",I),rt.append("button").text("Zoom -").classed("d3-mindmap-little-button",!0).attr("id","zoom_out").on("click",I);B?nt.on("contextmenu",d3.contextMenu(Q)):nt.on("contextmenu",d3.contextMenu($));var it=d3.scale.linear().domain([-Z/2,Z/2]).range([0,Z]),ot=d3.scale.linear().domain([-height/2,height/2]).range([height,0]),dt=d3.svg.axis().scale(it).orient("bottom").tickSize(-height),at=d3.svg.axis().scale(ot).orient("left").ticks(5).tickSize(-Z),lt=d3.behavior.zoom().scaleExtent([.2,2.5]).x(it).y(ot).center([Z/2,height/2]).size([Z,height]);P&&P.viewport&&P.viewport.scale&&lt.scale(P.viewport.scale),P&&P.viewport&&P.viewport.translate&&lt.translate(P.viewport.translate),lt.on("zoom",o);var ct=d3.select("div#"+H).append("svg").attr("id","d3-mindmap-svg-root").classed("d3-mindmap-svg",!0).attr("width",D).attr("height",T).attr("pointer-events","all").append("g").call(lt);ct.append("g").attr("class","d3-x-axis").attr("transform","translate(0,"+height+")").call(dt),ct.append("g").attr("class","d3-y-axis").call(at),rect=ct.append("g").attr("width",Z).attr("height",height),ct.append("svg:defs").selectAll("marker").data(["end"]).enter().append("svg:marker").attr("id",String).attr("viewBox","0 -5 10 10").attr("refX",25).attr("refY",0).attr("markerWidth",6).attr("markerHeight",6).attr("orient","auto").append("svg:path").attr("d","M0,-5L10,0L0,5L0,-5").attr("stroke-width",1).attr("stroke","#c0c0c0").attr("fill","#606060");var ut=rect.selectAll(".d3-mindmap-link"),ft=rect.selectAll(".d3-mindmap-node");o(P.viewport),d(q);var pt}; 
