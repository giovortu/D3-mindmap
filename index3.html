<!DOCTYPE html>
<meta charset="utf-8">
<style>
.link {

        fill: none;
        stroke: #666;
        stroke-width: 1.5px;
        pointer-events: none;
    }


    rect {

        fill: #ffffff;
        stroke: #45454a;
        stroke-width: 3px;
    }

    rect.hover {

        fill: #ff4d4a;
        stroke: #45454a;
        stroke-width: 0px;
    }

    text {


        font-family: sans-serif;
        font-weight: bold;
        pointer-events: none;
        fill: #000000;
        stroke-width: 0px;
        cursor: hand;


        -webkit-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        user-select: none;
    }



    text.hover {

        font-weight: bold;
        pointer-events: none;
        fill: #ffffff;
        stroke-width: 0px;
        cursor: hand;

        -webkit-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        user-select: none;
    }

    .little-button,
    .little-button:hover {
        width: 80px;
        height: 30px;
        font-size: 12px;

        margin-right: 5px;
    }



    #renamer .inner {

        width: 190px;
        margin: 5px;
    }

    #renamer textarea.rename-title {
        height: 50px;
    }


   #details, #renamer {
        position: absolute;
        width: 290px;
        background: #c0c0c0;
        opacity: 0.8;
        padding: 10px;
        border: 1px solid #ff4d4a;
        border-radius: 15px;
    }

    #renamer span {
        font-family: "Verdana", Times, serif;
    }

    #renamer form {
        border: 0px;
        width: 100%;
    }

    #renamer textarea {
        border: 1px solid #ff4d4a;
        border-radius: 15px;
        width: 85%;
        height: 100px;
        padding: 10px;
        margin: 5px;
        outline: none;
        resize: none;
        font-family: "Verdana", Times, serif;
    }

    #renamer input {
        border: 1px solid #ff4d4a;
        border-radius: 15px;
        width: 85%;
        padding: 10px;
        outline: none;
        margin: 5px;
        font-family: "Verdana", Times, serif;
    }

    .parent {
        stroke: #00ff00;
    }


    .leaf {
        stroke: #00ffff;
    }

    .plus {
        fill: #ff00ff;
        stroke: "#90ff90;
 stroke-width:1px;
    }

    .minus {
        fill: #00ffff;
        stroke: "#ffff90;
 stroke-width:1px;
    }



    .hyperlink {

        font-style: italic;
        fill: #ff4d4a;
    }



    .d3-context-menu {
        position: absolute;
        display: none;
        background-color: #f2f2f2;
        border-radius: 4px;

        font-family: Arial, sans-serif;
        font-size: 14px;
        min-width: 150px;
        border: 1px solid #d4d4d4;

        z-index: 1200;
    }

    .d3-context-menu ul {
        list-style-type: none;
        margin: 4px 0px;
        padding: 0px;
        cursor: default;
    }

    .d3-context-menu ul li {
        padding: 4px 16px;
    }

    .d3-context-menu ul li:hover {
        background-color: #4677f8;
        color: #fefefe;
    }

    #container {
        background: transparent;
    }

    svg {
        border: 1px solid #ff4d4a;
    }


    button {
        background-color: #ffffff;
        border: 3px solid #45454a;
        border-radius: 20px;
        padding: 0px;
        font-size: 16px;
        width: 158px;
        height: 40px;
        margin: 0px;
        color: #45454a;
        outline: none;
    }

    button:hover {
        background-color: #ff4d4a;
        border: 3px solid #ff4d4a;
        border-radius: 20px;
        padding: 0px;
        font-size: 16px;
        width: 158px;
        height: 40px;
        margin: 0px;
        color: #ffffff;
        outline: none;
    }
}
</style>

<body onload="makeD3( { 'editable': true } )">

    <div id="container"></div>
    <textarea id="result"></textarea>

    <script src="//d3js.org/d3.v3.min.js"></script>

    <script>
        function makeD3(options) {

            var lastNodeID = 0;

            if (typeof JSON.clone !== "function") {
                JSON.clone = function(obj) {
                    return JSON.parse(JSON.stringify(obj));
                };
            }

            var enableEdit = options && options.editable;
            
            d3.keybinding = function() {
    // via https://github.com/keithamus/jwerty/
    // and https://github.com/madrobby/keymaster
    var _keys = {
        // MOD aka toggleable keys
        mods: {
            // Shift key, ⇧
            '⇧': 16,
            // CTRL key, on Mac: ⌃
            '⌃': 17,
            // ALT key, on Mac: ⌥ (Alt)
            '⌥': 18,
            // META, on Mac: ⌘ (CMD), on Windows (Win), on Linux (Super)
            '⌘': 91
        },
        // Normal keys
        keys: {
            // Backspace key, on Mac: ⌫ (Backspace)
            '⌫': 8, backspace: 8,
            // Tab Key, on Mac: ⇥ (Tab), on Windows ⇥⇥
            '⇥': 9, '⇆': 9, tab: 9,
            // Return key, ↩
            '↩': 13, 'return': 13, enter: 13, '⌅': 13,
            // Pause/Break key
            'pause': 19, 'pause-break': 19,
            // Caps Lock key, ⇪
            '⇪': 20, caps: 20, 'caps-lock': 20,
            // Escape key, on Mac: ⎋, on Windows: Esc
            '⎋': 27, escape: 27, esc: 27,
            // Space key
            space: 32,
            // Page-Up key, or pgup, on Mac: ↖
            '↖': 33, pgup: 33, 'page-up': 33,
            // Page-Down key, or pgdown, on Mac: ↘
            '↘': 34, pgdown: 34, 'page-down': 34,
            // END key, on Mac: ⇟
            '⇟': 35, end: 35,
            // HOME key, on Mac: ⇞
            '⇞': 36, home: 36,
            // Insert key, or ins
            ins: 45, insert: 45,
            // Delete key, on Mac: ⌦ (Delete)
            '⌦': 46, del: 46, 'delete': 46,
            // Left Arrow Key, or ←
            '←': 37, left: 37, 'arrow-left': 37,
            // Up Arrow Key, or ↑
            '↑': 38, up: 38, 'arrow-up': 38,
            // Right Arrow Key, or →
            '→': 39, right: 39, 'arrow-right': 39,
            // Up Arrow Key, or ↓
            '↓': 40, down: 40, 'arrow-down': 40,
            // odities, printing characters that come out wrong:
            // Num-Multiply, or *
            '*': 106, star: 106, asterisk: 106, multiply: 106,
            // Num-Plus or +
            '+': 107, 'plus': 107,
            // Num-Subtract, or -
            '-': 109, subtract: 109,
            // Semicolon
            ';': 186, semicolon:186,
            // = or equals
            '=': 187, 'equals': 187,
            // Comma, or ,
            ',': 188, comma: 188,
            //'-': 189, //???
            // Period, or ., or full-stop
            '.': 190, period: 190, 'full-stop': 190,
            // Slash, or /, or forward-slash
            '/': 191, slash: 191, 'forward-slash': 191,
            // Tick, or `, or back-quote
            '`': 192, tick: 192, 'back-quote': 192,
            // Open bracket, or [
            '[': 219, 'open-bracket': 219,
            // Back slash, or \
            '\\': 220, 'back-slash': 220,
            // Close backet, or ]
            ']': 221, 'close-bracket': 221,
            // Apostraphe, or Quote, or '
            '\'': 222, quote: 222, apostraphe: 222
        }
    };
    // To minimise code bloat, add all of the NUMPAD 0-9 keys in a loop
    var i = 95, n = 0;
    while (++i < 106) _keys.keys['num-' + n] = i; ++n;
    // To minimise code bloat, add all of the top row 0-9 keys in a loop
    i = 47, n = 0;
    while (++i < 58) _keys.keys[n] = i; ++n;
    // To minimise code bloat, add all of the F1-F25 keys in a loop
    i = 111, n = 1;
    while (++i < 136) _keys.keys['f' + n] = i; ++n;
    // To minimise code bloat, add all of the letters of the alphabet in a loop
    i = 64;
    while(++i < 91) _keys.keys[String.fromCharCode(i).toLowerCase()] = i;

    var pairs = d3.entries(_keys.keys),
        event = d3.dispatch.apply(d3, d3.keys(_keys.keys));

    function keys(selection) {
        selection.on('keydown', function () {
            var tagName = d3.select(d3.event.target).node().tagName;
            if (tagName == 'INPUT' || tagName == 'SELECT' || tagName == 'TEXTAREA') {
                return;
            }

            var modifiers = '';
            if (d3.event.shiftKey) modifiers += '⇧';
            if (d3.event.ctrlKey) modifiers += '⌃';
            if (d3.event.altKey) modifiers += '⌥';
            if (d3.event.metaKey) modifiers += '⌘';

            pairs.filter(function(d) {
                return d.value === d3.event.keyCode;
            }).forEach(function(d) {
                event[d.key](d3.event, modifiers);
            });
        });
    }

    return d3.rebind(keys, event, 'on');
};



            d3.contextMenu = function(menu, openCallback) {

                // create the div element that will hold the context menu
                d3.selectAll('.d3-context-menu').data([1])
                    .enter()
                    .append('div')
                    .attr('class', 'd3-context-menu');

                // close menu
                d3.select('body').on('click.d3-context-menu', function() {
                    d3.select('.d3-context-menu').style('display', 'none');
                });
                
                

                // this gets executed when a contextmenu event occurs
                return function(data, index) {
                    var elm = this;

                    d3.selectAll("div#renamer").remove();
                    
                    d3.selectAll('.d3-context-menu').html('');
                    var list = d3.selectAll('.d3-context-menu').append('ul');
                    
                    var __x = d3.event.pageX;
                    var __y = d3.event.pageY;
                    
                    list.selectAll('li').data(menu).enter()
                        .append('li')
                        .html(function(d) {
                            return d.title;
                        })
                        .on('click', function(d, i) {
                            d.action(elm, data, index, __x, __y);
                            d3.select('.d3-context-menu').style('display', 'none');
                        });

                    // the openCallback allows an action to fire before the menu is displayed
                    // an example usage would be closing a tooltip
                    if (openCallback) openCallback(data, index);

                    // display context menu
                    d3.select('.d3-context-menu')
                        .style('left', (d3.event.pageX - 2) + 'px')
                        .style('top', (d3.event.pageY - 2) + 'px')
                        .style('display', 'block');

                    d3.event.preventDefault();
                };
            };


            d3.selection.prototype.moveToFront = function() {
                return this.each(function() {
                    this.parentNode.appendChild(this);
                });
            };
            
 

            var width = 960,
                height = 500,
                root = null,
                rectWidth = 120,
                rectHeight = 20,
                radius = 15,
                textXMargin = 10,
                textYMargin = 10,
                boxRadius = 20,
                zoom = 1.3,
                animInTime = 200,
                animOutTime = 700,
                fontSize = 12,
                boundingRadius = 1,
                linkWeight = 2,
                min_zoom = 0.1
                max_zoom = 7,
                scale = 1,
                initialDistance = 150



            function wrap(text, width) {
                text.each(function() {

                    var text = d3.select(this),
                        words = text.attr("title").split(/\r?\n/)

                    interline = 10;

                    lines = 0

                    text.text("");

                    words.forEach(function(word) {
                        tspan = text.append("tspan").attr("x", 0).attr("dy", fontSize).text(word);
                    })


                })
            }



            var root =[];
            
            function edit(elm, d, i, _x,_y) {

                        if (d) {
                            console.log(d)
                            var nn = findNode(d.id, root);
                            var tt = svg.select("#JIKU_MM_TEXT_" + nn.id)[0][0];
                            var cc = svg.select("#JIKU_MM_CIRCLE_" + nn.id)[0][0];
                            
                            d3.selectAll("div#renamer").remove();
                            
                            if (tt) {
                            
                                var txt = nn.name;
                                var textcontent = nn.textcontent || ""


                                var txtElem = d3.select(tt);
                                var circleElem = d3.select(cc);

                                
                                function submit() {
                                    var _title = title.node().value;

                                    nn.name = _title;

                                    txtElem.attr("title", _title).call(wrap);

                                    var _content = inp.node().value;
                                    nn.textcontent = _content;

                                    if( _content && _content != "" )
                                    {
                                        circleElem.attr("visibility", "visible");
                                    }

                                    removed = true;
                                    d3.selectAll("div#renamer").remove();
                                    update(root);
                                }

                                frm = d3.select("body").append("div").attr("id", "renamer").attr("style", "top:" + _y + "px; left:" + _x + "px;")

                                var removed = false;

                                form = frm
                                    .attr("x", d.x)
                                    .attr("y", d.y)
                                    .append("xhtml:form")
                                    .on("submit", function() {
                                        d3.event.preventDefault();
                                        return null;
                                    })
                                    .classed("rename-form", true)

                                form.append("span").text("Titolo")

                                title = form
                                    .append("textarea")
                                    .classed("rename-title", true)



                                title
                                    .attr("placeholder", "Inserire il titolo...")
                                    .attr("value", function() {
                                        this.focus();
                                        title[0][0].value = txt;
                                        return txt;
                                    })
                                
                                form.append("span").text("Contenuto")

                                inp = form
                                    .append("textarea")
                                    .attr("placeholder", "Inserire il contenuto...")
                                    .classed("rename-form", true)

                                inp.attr("value", function() {

                                    inp[0][0].value = textcontent;
                                    return textcontent;
                                })

                                
                                buttContainer = form.append("div")

                                buttContainer.classed("inner", true)


                                canc = buttContainer.append("xhtml:button")
                                    .classed("little-button", true)
                                    .text("Annulla")
                                    .on("click", function() {
                                        removed = true;
                                        d3.selectAll("div#renamer").remove();
                                        //update( root );

                                    })




                                ok = buttContainer.append("xhtml:button")
                                    .classed("little-button", true)
                                    .text("Salva")
                                    .on("click", submit)

                                w = d3.select('svg').clientWidth;
                                h = d3.select('svg').clientHeight;

                                _bound = d3.select(renamer).node().getBoundingClientRect();

                                px = _bound.left;
                                py = _bound.top;

                                //console.log(d3.select(renamer))

                            }
                        }
                    }

            
           

            var mainMenu = [{
                    title: 'Add new node',
                    action: function(elm, d, i, _x,_y) {


                        var newNode = JSON.clone(emptyNode);
                        newNode.id = ++lastNodeID;
                        newNode.name = "Node #" + lastNodeID;
                        newNode.isLeaf = true;
                        newNode.x = _x;
                        newNode.y = _y;
                        newNode.fixed = true

                        if (!Array.isArray(root)) {
                            root = [root];
                        }

                        root.push(newNode);
                        
                        update(root);

                        edit(elm, newNode, i, _x,_y)

                    }
                }
                /*,
                        {
                            title: 'Expand all',
                            action: function(elm, d, i) {
                            }
                            
                        },
                        {
                            title: 'Collapse all',
                            action: function(elm, d, i) {
                            }
                            
                        }*/
            ]

            var input;

            var menu = [{
                    title: 'Add sub node',
                    action: function(elm, d, i, _x,_y) {

                        if (d) {
                            var nn = findNode(d.id, root);
                            console.log(d.id);
                            console.log("-----------");
                            console.log(nn);
                            if (nn.isLeaf) {
                                nn.children = [];
                                nn._children = null;
                            }

                            var child = nn.children || nn._children || null;

                            if (child) {
                            
                                var angle = Math.random() * 2 * Math.PI;
                                
                                var newNode = JSON.clone(emptyNode);
                                newNode.id = ++lastNodeID;
                                newNode.name = "Node #" + lastNodeID;
                                newNode.x = nn.x + initialDistance * Math.sin( angle );
                                newNode.y = nn.y + initialDistance * Math.cos( angle ) ;
                                newNode.fixed = true

                                child.push(newNode);
                                nn.isLeaf = false;
                                var tt = svg.select("#JIKU_MM_RECT_" + nn.id);

                                if (tt) {
                                    tt.attr("class", "parent");
                                }
                                //collapse( [nn] )
                                //collapse( [nn] )
                                update(root)
                                
                                edit(elm, newNode, i, _x,_y)
                            }

                            

                        }
                    }
                },
                {
                    title: 'Edit node',
                    action: function(elm, d, i, _x,_y) { edit(elm, d, i, _x,_y); }

                },
                {
                    title: 'Remove node',
                    action: function(elm, d, i) {
                        if (d) {
                            var nn = removeNode(d.id, root);
                            update(root);
                        }
                    }
                }
            ]



            var emptyNode = {
                "name": "New node",
                "isLeaf": true,
                "url": ""

            }


            var force = d3.layout.force()

                .size([width, height])
                .on("tick", tick)



            var div = d3.selectAll("div#container")

            div.style("width", width).style("height", height);

            if (enableEdit) {
                div.on('contextmenu', d3.contextMenu(mainMenu));
            }
            
           
            
            function translateandrescale() {
            
            

                scale=d3.event.scale;
                trans=d3.event.translate;
                
                console.log( "scale",scale )
                
                console.log( "trans",trans )

                
                tr2 = [ trans[0] /scale    , trans[1]/scale  ]

                svg.attr("transform", "scale(" + scale + ")" + "translate(" + tr2 + ")" );
                
               
            }
            
            
            var zoom = d3.behavior.zoom()            
                .center([width / 2, height / 2])
                .size([width, height])
        
            
            zoom.on("zoom", translateandrescale);

            var outer = div.append("svg")
                .attr("width", width)
                .attr("height", height)
                .attr("pointer-events", "all");
                
                
 
            var svg = outer
                .call(zoom)
                .append('svg:g')
                     

            outer.append("svg:defs").selectAll("marker")
                    .data(["end"])      // Different link/path types can be defined here
                    .enter().append("svg:marker")    // This section adds in the arrows
                    .attr("id", String)
                    .attr("viewBox", "0 -5 10 10")
                    .attr("refX", 25)
                    .attr("refY", 0)
                    .attr("markerWidth", 6)
                    .attr("markerHeight", 6)
                    .attr("orient", "auto")
                    .append("svg:path")
                    .attr("d", "M0,-5L10,0L0,5");
                
                

            var link = svg.selectAll(".link")
            
            
            var node = svg.selectAll(".node");


            var rootNodes = findRootNodes(root);


            update(root)
            collapse(findRootNodes(root));
            update(root)
           

            var flroot;



            function update(root) {


                var nodes = flatten(root),
                    links = d3.layout.tree().links(nodes)


                flroot = nodes;

                rootNodes = findRootNodes(root);

                if (enableEdit) {
                    console.log(filterAll(root));
                    document.getElementById("result").value = JSON.stringify(filterAll(root));
                }
                //console.log( root );


                // Restart the force layout.
                force
                    .nodes(nodes)
                    .links(links)
                    .linkDistance(fontSize * 10)
                    .charge(-620)
                    .gravity(.05)
                    .friction(0.9)
                    .size([width, height])                    
                    .start()


                var drag = force.drag()
                
                drag
                .on("drag", nodedrag )
                .on("dragstart", dragstart);


                // Update links.
                link = link.data(links, function(d) {
                    return d.target.id;
                })


                link.exit().remove();
                

                link.enter().insert("path", ".node")
                    .attr("class", "link")
                    .style("stroke-width", linkWeight)
                    .attr("marker-end", "url(#end)");

                // Update nodes.
                node = node.data(nodes, function(d) {
                    return d.id;
                });

                node.exit().remove();


                var nodeEnter = node.enter().append("g")
                    .attr("id", function(d) {
                            return "JIKU_MM_NODE_" + d.id;
                    })
                    .attr("class", "node")
                    .on("click", onclick)
                    .on("touchstart", onclick)
                    .on("mouseup", mouseup)
                    .on("mousedown", mousedown)
                    .on("mouseover", mouseover)
                    .on("mouseout", mouseout)
                    .call(drag)



                var a = nodeEnter.append("a")
                
                   

                var rect = a.append("rect")
                    .attr("x", 0)
                    .attr("y", 0)
                    .attr("rx", boxRadius)
                    .attr("ry", boxRadius)
                    .attr("height", rectHeight)
                    .attr("width", rectWidth)
                    .attr("id", function(d) {
                        return "JIKU_MM_RECT_" + d.id;
                    })
                    .attr("class", function(d) {
                        if (hasValue(d.isLeaf)) {
                            if (d.isLeaf) {
                                return "leaf";
                            } else {
                                return "parent"

                            }
                        }

                    })




                var txt = a.append("text")


                    .attr("class", "text")
                    .style("text-anchor", "middle")
                    .style("font-size", fontSize + "px")
                    .attr("id", function(d) {
                        return "JIKU_MM_TEXT_" + d.id;
                    })
                    .attr("class", function(d) {
                        if (d.url) {
                            return "hyperlink";
                        }
                    })
                    .attr("title", function(d) {
                        return d.name;
                    })
                    .call(wrap);

                           
             
                var circle = nodeEnter.append("circle")
                    .style("fill","#50e050")
                    .style("stroke","#505020")
                    .attr("cx",0)
                    .attr("cy",0)
                    .attr("r", 10)
                    .attr("id", function(d) {
                        return "JIKU_MM_CIRCLE_" + d.id;
                    })
                    .on("mouseover", clickContent)
                    .on("mouseout", outContent)
                    .attr("visibility", function(d,i){
                    
                        if(d.textcontent) 
                            return "visible";
                        return "hidden";
                    
                })
                
               

                var gs = d3.selectAll('g.node');

                if (enableEdit) {
                    a.on('contextmenu', d3.contextMenu(menu));
                }

                gs[0].forEach(function(elem) {

                  
                    childs = elem.childNodes;
                    
                    anchors = childs[0].childNodes;
                    

                    var _rect = anchors[0];
                    var _text = anchors[1];

                    var textSize = _text.getBBox();


                    w = textSize.width + 2 * textXMargin;
                    h = textSize.height + 2 * textYMargin;


                    _rect.setAttribute("x", -w / 2);
                    _rect.setAttribute("y", -h / 2);

                    _text.setAttribute("y", -h / 2 + fontSize / 1.5);

                    _rect.setAttribute("width", w)
                    _rect.setAttribute("height", h)
                    
                    var _circles = childs[1];                    
                    _circles.cx.baseVal.value =  w/2;
                    _circles.cy.baseVal.value =  h/2;


                });


            }


            
            function linkArc(d) {          
            
               perc = 0.7;
            
               targetX = (d.source.x + perc * ( d.target.x- d.source.x ) )
               targetY = (d.source.y + perc * ( d.target.y- d.source.y ) )
               return "M"+  d.target.x + "," + d.target.y + "L" +  + d.source.x + "," + d.source.y + "M" + targetX + "," + targetY;
            }

            
     
            

            function tick() {
            
            link.attr("d", linkArc);
            

                node.attr("transform", function(d) {   

                    return "translate(" +d.x + "," + d.y + ")";
                    
                });

                

            }



            function hasValue(d) {
                return d !== null && typeof d !== 'undefined';

            }

            function hasChilds(d) {
                var ret = false;

                ret = hasValue(d.children) || hasValue(d._children);

                return ret;

            }


            function collapse(nodes) {

                nodes.forEach(function(d) {

                    if (d.children) {

                        if (hasValue(d)) {
                            console.log("Collapsing " + d.id);
                            var jNode = findJsonNode(d.id, flroot);

                            console.log(jNode.id + " has CHILD collapsed, was " + jNode.status);
                            jNode.status = "collapsed";

                            //jNode.isLeaf = false;


                        }


                        d._children = d.children;
                        d.children = null;

                    } else {
                        d.children = d._children;
                        d._children = null;

                        if (hasChilds(d)) {
                            console.log("Expanding " + d.id);

                            var jNode = findJsonNode(d.id, flroot);

                            console.log(jNode.id + " has CHILD expanded, was " + jNode.status);

                            jNode.status = "expanded";

                            //jNode.isLeaf = false;
                        }


                    }


                });



            }




            function findJsonNode(id, root) {

                if (hasValue(root)) {
                    for (i = 0; i < root.length; i += 1) {
                        if (root[i].id === id) {
                            return root[i];
                        }
                    }
                }

                return null;
            }

            function removeNode(id, _root) {

                var i,
                    elem;

                console.log("Removing " + id);

                if (Array.isArray(_root)) {

                    for (i = 0; i < _root.length; i++) {

                        elem = _root[i];


                        if (elem.id == id) {
                            _root.splice(i, 1);
                        } else {
                            _remove(id, elem);
                        }

                    }

                } else {
                    _remove(id, _root)
                }

                function _remove(id, currentNode) {
                    var _j, currentChild;

                    if (hasValue(currentNode)) {

                        if (currentNode.children) parseChilds(id, currentNode.children);
                        if (currentNode._children) parseChilds(id, currentNode._children);


                        function parseChilds(id, childs) {

                            for (_j = 0; _j < childs.length; _j++) {
                                currentChild = childs[_j];

                                //console.log(currentNode.name + ", numChilds=" +  childs.length +", index=" + _j + " name=" +currentChild.name +" id=" + currentChild.id );

                                if (currentChild.id == id) {
                                    console.log("Found, removing ");
                                    childs.splice(_j, 1);
                                    if (childs.length == 0) {
                                        currentNode.isLeaf = true;

                                        var tt = svg.select("#JIKU_MM_RECT_" + currentNode.id);

                                        if (tt) {
                                            tt.attr("class", "leaf");
                                        }

                                    }
                                    return currentChild;

                                } else {
                                    _remove(id, currentChild);
                                }

                            }
                        }
                    }

                }


            }

            function filterAll(_currentNode) {

                var i,
                    elem;

                var currentNode = JSON.clone(_currentNode);

                console.log("Filtering ");

                if (Array.isArray(currentNode)) {

                    for (i = 0; i < currentNode.length; i++) {

                        elem = currentNode[i];

                        _filter(elem);

                    }

                } else {
                    _filter(currentNode)
                }

                function _filter(currentNode) {
                    var _j, currentChild;

                    delete currentNode.x;
                    delete currentNode.y;
                    delete currentNode.px;
                    delete currentNode.py;
                    delete currentNode.weight;
                    delete currentNode.isLeaf;
                    delete currentNode.index;
                    delete currentNode.size;
                    delete currentNode.status;

                    if (hasValue(currentNode)) {

                        if (currentNode._children) {
                            if (currentNode.children) {

                            } else {
                                currentNode.children = [];
                            }

                            for (_j = 0; _j < currentNode._children.length; _j++) {
                                currentNode.children.push(currentNode._children[_j])
                            }


                        }

                        delete currentNode._children;

                        if (currentNode.children) parseChilds(currentNode.children);
                        if (currentNode._children) parseChilds(currentNode._children);




                        function parseChilds(childs) {

                            for (_j = 0; _j < childs.length; _j++) {
                                currentChild = childs[_j];


                                _filter(currentChild);

                            }
                        }
                    }

                }

                return currentNode;


            }


            function findNode(id, currentNode) {

                var i,
                    currentChild,
                    result;

                console.log("find " + id);
                console.log(currentNode)

                if (Array.isArray(currentNode)) {
                    for (var i = 0; i < currentNode.length; i++) {
                        elem = currentNode[i];
                        console.log("recurring");
                        res = findNode(id, elem);
                        if (res !== false)
                            return res;
                    }

                } else {

                    if (id == currentNode.id) {
                        console.log("Found");
                        console.log(currentNode);

                        return currentNode;
                    } else {

                        if (hasValue(currentNode)) {
                            if (hasValue(currentNode.children)) {

                                for (var i = 0; i < currentNode.children.length; i += 1) {

                                    currentChild = currentNode.children[i];

                                    // Search in the current child
                                    result = findNode(id, currentChild);

                                    // Return the result if the node has been found
                                    if (result !== false) {
                                        return result;
                                    }
                                }

                            }

                        }


                    }

                }
                return false;
            }


            // Returns a list of all nodes under the root.
            function findRootNodes(root) {

                var _rootNodes = [],
                    i = 0;


                if (Array.isArray(root)) {
                    root.forEach(function(elem) {
                        recurse(elem);
                    });

                } else {
                    recurse(root);

                }

                function recurse(node) {


                    if (node.children) {
                        node.size = node.children.reduce(function(p, v) {
                            return p + recurse(v);
                        }, 0);

                        _rootNodes.push(node);
                    }


                }


                return _rootNodes;
            }




            // Returns a list of all nodes under the root.
            function flatten(root) {

                var nodes = []


                if (Array.isArray(root)) {
                    root.forEach(function(elem) {

                        flat = flatten(elem);
                        flat.forEach(function(e) {
                            nodes.push(e);
                        });


                    });

                } else {

                    recurse(root);

                }

                function recurse(node) {

                    node.isLeaf = true;


                    if (node.children) {
                        node.size = node.children.reduce(function(p, v) {
                            //v.parent = node ;
                            return p + recurse(v);
                        }, 0);
                        node.isLeaf = false;

                    } else
                    if (node._children) {
                        //node.size = node._children.reduce(function(p, v) { return p + recurse(v); }, 0);
                        node.isLeaf = false;
                    }

                    if (!node.id) node.id = ++lastNodeID;


                    nodes.push(node);
                }


                return nodes;
            }

            // Toggle children on click.
            function onclick(d) {


                if (d3.event.defaultPrevented) return;

                var graph = d3.select(this)
                var selection = d3.select(this).select("rect");


                if (d.children) {

                    if (hasValue(d)) {
                        console.log("Collapsing " + d.id);
                        var jNode = findJsonNode(d.id, flroot);

                        console.log(jNode.id + " has CHILD collapsed, was " + jNode.status);
                        jNode.status = "collapsed";

                        jNode.isLeaf = false;


                    }


                    d._children = d.children;
                    d.children = null;

                } else {
                    d.children = d._children;
                    d._children = null;

                    if (hasChilds(d)) {
                        //console.log("Expanding " + d.id);

                        var jNode = findJsonNode(d.id, flroot);

                        //console.log(jNode.id + " has CHILD expanded, was " + jNode.status);

                        jNode.status = "expanded";

                        jNode.isLeaf = false;
                    }


                }
                update(root);

            }
            

            function dragstart(d) {
            
                d3.event.sourceEvent.stopPropagation();
                
               

            }
            
            var shiftClicked = false;
            var ctrlClicked = false;
            
            function nodedrag(dd) {
            
            if ( !ctrlClicked ) return;
             
            
                var selection = d3.selectAll("#JIKU_MM_NODE_" + dd.id);
                
                
                
                if ( dd.children )
                {
                    dd.children.forEach( function( elem ){
                    
                    
                    
                    var n = d3.select( "#JIKU_MM_NODE_" + elem.id );   
                    
                    nodedrag( elem );
                    
                         
                    n.attr("transform", function( d) {
                    
                    d.px = d.px +d3.event.dx
                    d.py = d.py +d3.event.dy
                    
                     })
                     
                   });
                    
                }

            
            
            }
            
            function mouseup(d) {
            
            }
            
            function mousedown(d) {
            
               shiftClicked = d3.event.shiftKey;
               ctrlClicked = d3.event.ctrlKey;
            
            }

            
            function mouseover(d) {
            
                div = d3.selectAll("div#container")

                if (enableEdit) {
                    input = d3.select("#renamer")[0][0];
                    if (input) return;
                }
                
                zoom.on("zoom", function(){});

                outer.call(zoom.event)


                var selection = d3.select(this).select("rect");
                
                
                var text = d3.select(this).select("text");
               
                
                d3.select(this).moveToFront();

                selection.classed("hover", true);
                text.classed("hover", true);


                    
                if (enableEdit) {

                    div.on('contextmenu', null);
                    selection.on('contextmenu', d3.contextMenu(menu));
                }


            }

            function mouseout(e) {
            
                div = d3.selectAll("div#container")
                
               
              
                zoom.on("zoom",translateandrescale );
                outer.call(zoom)


                var selection = d3.select(this).select("rect");
                var text = d3.select(this).select("text");

                selection.classed("hover", false);
                text.classed("hover", false);

                if (enableEdit) {

                    div.on('contextmenu', d3.contextMenu(mainMenu));
                    selection.on('contextmenu', null);
                }

            }
            
            
            function clickContent(d){
            
                d3.event.preventDefault();
            
               
                div = d3.selectAll("div#container")
            
           
                rem = d3.selectAll("div#details");
                
                  
                if ( !rem.empty() )
                {
                    rem.remove();
                    return;
                }
                
                div.on('contextmenu', d3.contextMenu(mainMenu));
            
                if ( d.textcontent )
                {
                
                    div = d3.select("body").append("div")
                    
                    div.attr("id", "details").attr("style", "top:" + d3.event.pageY + "px; left:" + d3.event.pageX + "px;")
                    
                    div.append("span").text( d.textcontent );
                    
                    
                }
                
                
                                    
            
            }
            
            function outContent(d){
            
                d3.selectAll("div#details").remove();
                //div.on('contextmenu', d3.contextMenu(mainMenu));
            
            }

        }
 


 
 </script>


</body>

</html>
